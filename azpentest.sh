#!/bin/bash

# Azure Pentesting Tools Setup Script
# Manages BloodHound CE and cloud-tools container
# Based on: https://bloodhound.specterops.io/get-started/quickstart/community-edition-quickstart

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# BloodHound installation directory
BH_DIR="bloodhound"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BH_ABS_DIR="${SCRIPT_DIR}/${BH_DIR}"

# Detect OS and architecture
detect_os_arch() {
    OS="$(uname -s)"
    ARCH="$(uname -m)"
    
    case "$OS" in
        Linux*)
            OS_NAME="linux"
            ;;
        Darwin*)
            OS_NAME="darwin"
            ;;
        *)
            echo -e "${RED}Error: Unsupported operating system: $OS${NC}"
            exit 1
            ;;
    esac
    
    case "$ARCH" in
        x86_64|amd64)
            ARCH_NAME="amd64"
            ;;
        arm64|aarch64)
            ARCH_NAME="arm64"
            ;;
        *)
            echo -e "${RED}Error: Unsupported architecture: $ARCH${NC}"
            exit 1
            ;;
    esac
    
    echo -e "${BLUE}Detected: $OS_NAME-$ARCH_NAME${NC}"
}

# Check if Docker is installed and running
check_docker() {
    echo -e "${BLUE}Checking Docker installation...${NC}"
    
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}Error: Docker is not installed.${NC}"
        echo -e "${YELLOW}Please install Docker Desktop from: https://www.docker.com/get-started${NC}"
        exit 1
    fi
    
    if ! docker info &> /dev/null; then
        echo -e "${RED}Error: Docker daemon is not running.${NC}"
        echo -e "${YELLOW}Please start Docker Desktop and try again.${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}Docker is installed and running.${NC}"
}

# Check if bloodhound-cli is installed
check_bloodhound_cli() {
    if command -v bloodhound-cli &> /dev/null; then
        echo -e "${GREEN}BloodHound CLI is already installed.${NC}"
        return 0
    fi
    
    # Check for local binary in BloodHound directory
    if [ -f "${BH_ABS_DIR}/bloodhound-cli" ]; then
        echo -e "${GREEN}Found BloodHound CLI in ${BH_DIR}/ directory.${NC}"
        chmod +x "${BH_ABS_DIR}/bloodhound-cli"
        return 0
    fi
    
    return 1
}

# Create BloodHound directory if it doesn't exist
setup_bloodhound_dir() {
    if [ ! -d "$BH_ABS_DIR" ]; then
        echo -e "${BLUE}Creating BloodHound installation directory: ${BH_DIR}/${NC}"
        mkdir -p "$BH_ABS_DIR"
    fi
}

# Download and install bloodhound-cli
install_bloodhound_cli() {
    echo -e "${BLUE}Downloading BloodHound CLI...${NC}"
    
    setup_bloodhound_dir
    
    FILENAME="bloodhound-cli-${OS_NAME}-${ARCH_NAME}"
    cd "$BH_ABS_DIR"
    
    if [ "$OS_NAME" = "darwin" ]; then
        DOWNLOAD_URL="https://github.com/SpecterOps/bloodhound-cli/releases/latest/download/${FILENAME}.tar.gz"
        curl -L -o "${FILENAME}.tar.gz" "$DOWNLOAD_URL"
        tar -xvzf "${FILENAME}.tar.gz"
        rm "${FILENAME}.tar.gz"
    else
        DOWNLOAD_URL="https://github.com/SpecterOps/bloodhound-cli/releases/latest/download/${FILENAME}.tar.gz"
        wget -q "$DOWNLOAD_URL" -O "${FILENAME}.tar.gz"
        tar -xvzf "${FILENAME}.tar.gz"
        rm "${FILENAME}.tar.gz"
    fi
    
    chmod +x ./bloodhound-cli
    cd "$SCRIPT_DIR"
    echo -e "${GREEN}BloodHound CLI downloaded successfully to ${BH_DIR}/${NC}"
}

# Check if BloodHound is already installed
check_bloodhound_installed() {
    # Check for containers
    if docker ps -a --format '{{.Names}}' | grep -q ".*-bloodhound-.*"; then
        echo -e "${GREEN}BloodHound containers detected.${NC}"
        return 0
    fi
    
    # Check if docker-compose.yml exists in bloodhound directory
    if [ -f "${BH_ABS_DIR}/docker-compose.yml" ]; then
        echo -e "${YELLOW}BloodHound docker-compose.yml found in ${BH_DIR}/ directory.${NC}"
        return 0
    fi
    
    return 1
}

# Install BloodHound CE
install_bloodhound() {
    echo -e "${BLUE}Installing BloodHound Community Edition in ${BH_DIR}/ directory...${NC}"
    echo -e "${YELLOW}This may take a few minutes...${NC}"
    
    setup_bloodhound_dir
    cd "$BH_ABS_DIR"
    
    # Check if docker-compose.yml already exists and remove it to avoid conflicts
    if [ -f "docker-compose.yml" ]; then
        echo -e "${YELLOW}Removing existing docker-compose.yml to avoid conflicts...${NC}"
        rm -f docker-compose.yml docker-compose.dev.yml
    fi
    
    # Also check parent directory to be safe (though we're in bloodhound/ now)
    if [ -f "../docker-compose.yml" ] && [ ! -f "../Dockerfile" ]; then
        # Only warn if parent has docker-compose.yml but no Dockerfile (likely BloodHound's)
        echo -e "${YELLOW}Note: Found docker-compose.yml in parent directory, but we're installing in ${BH_DIR}/${NC}"
    fi
    
    # Run install - the CLI should work from the bloodhound/ directory
    # Suppress verbose output but show errors
    if [ -f "./bloodhound-cli" ]; then
        # Use yes command if available, otherwise pipe 'y' multiple times
        if command -v yes &> /dev/null; then
            yes 2>/dev/null | ./bloodhound-cli install >/dev/null 2>&1 || {
                # If install fails, show output for debugging
                yes 2>/dev/null | ./bloodhound-cli install
            }
        else
            # Pipe 'y' to handle the prompt
            printf 'y\ny\ny\n' 2>/dev/null | ./bloodhound-cli install >/dev/null 2>&1 || {
                printf 'y\ny\ny\n' 2>/dev/null | ./bloodhound-cli install
            }
        fi
    else
        echo -e "${RED}Error: BloodHound CLI not found in ${BH_DIR}/ directory.${NC}"
        cd "$SCRIPT_DIR"
        exit 1
    fi
    
    cd "$SCRIPT_DIR"
    echo -e "${GREEN}BloodHound installation completed in ${BH_DIR}/${NC}"
}

# Start BloodHound
start_bloodhound() {
    echo -e "${BLUE}Starting BloodHound services...${NC}"
    
    cd "$BH_ABS_DIR"
    
    if [ -f "./bloodhound-cli" ]; then
        ./bloodhound-cli up >/dev/null 2>&1
    else
        echo -e "${RED}Error: BloodHound CLI not found in ${BH_DIR}/ directory.${NC}"
        cd "$SCRIPT_DIR"
        exit 1
    fi
    
    cd "$SCRIPT_DIR"
    echo -e "${GREEN}BloodHound services started.${NC}"
}

# Stop BloodHound
stop_bloodhound() {
    echo -e "${BLUE}Stopping BloodHound services...${NC}"
    
    cd "$BH_ABS_DIR"
    
    if [ -f "./bloodhound-cli" ]; then
        ./bloodhound-cli down >/dev/null 2>&1
    else
        echo -e "${YELLOW}Warning: BloodHound CLI not found in ${BH_DIR}/ directory.${NC}"
        cd "$SCRIPT_DIR"
        return 1
    fi
    
    cd "$SCRIPT_DIR"
    echo -e "${GREEN}BloodHound services stopped.${NC}"
}

# Build and start cloud-tools container
build_cloud_tools() {
    echo -e "${BLUE}Building and starting cloud-tools container...${NC}"
    
    cd "$SCRIPT_DIR"
    
    if [ ! -f "docker-compose.yml" ]; then
        echo -e "${RED}Error: docker-compose.yml not found in project directory.${NC}"
        return 1
    fi
    
    if [ ! -f "Dockerfile" ]; then
        echo -e "${RED}Error: Dockerfile not found in project directory.${NC}"
        return 1
    fi
    
    echo -e "${YELLOW}Building cloud-tools container (this may take several minutes)...${NC}"
    docker-compose build --quiet cloud-tools 2>/dev/null || docker-compose build cloud-tools >/dev/null 2>&1
    
    echo -e "${YELLOW}Starting cloud-tools container...${NC}"
    docker-compose up -d cloud-tools >/dev/null 2>&1
    
    echo -e "${GREEN}cloud-tools container is running.${NC}"
    echo -e "${BLUE}Container name: ${GREEN}cloud-tools${NC}"
    echo -e "${BLUE}Access with: ${GREEN}docker exec -it cloud-tools bash${NC}"
}

# Get BloodHound password
get_bloodhound_password() {
    cd "$BH_ABS_DIR"
    
    if [ -f "./bloodhound-cli" ]; then
        PASSWORD=$(./bloodhound-cli config get default_password 2>/dev/null | grep -i "DEFAULT_PASSWORD" | awk '{print $NF}' || echo "")
    else
        PASSWORD=""
    fi
    
    cd "$SCRIPT_DIR"
    
    if [ -z "$PASSWORD" ]; then
        PASSWORD="<check installation logs>"
    fi
    
    echo "$PASSWORD"
}

# Main execution
main() {
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}BloodHound CE Setup Script${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    
    # Detect OS and architecture
    detect_os_arch
    echo ""
    
    # Check Docker
    check_docker
    echo ""
    
    # Check and install bloodhound-cli if needed
    if ! check_bloodhound_cli; then
        install_bloodhound_cli
        echo ""
    fi
    
    # Check if BloodHound is already installed
    if ! check_bloodhound_installed; then
        # Install BloodHound
        install_bloodhound
        echo ""
    else
        echo -e "${YELLOW}BloodHound appears to be already installed.${NC}"
        read -p "Do you want to reinstall? This will remove existing configuration. [y/N]: " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}Removing existing BloodHound installation...${NC}"
            cd "$BH_ABS_DIR"
            if [ -f "./bloodhound-cli" ]; then
                ./bloodhound-cli down >/dev/null 2>&1 || true
            fi
            rm -f docker-compose.yml docker-compose.dev.yml 2>/dev/null || true
            cd "$SCRIPT_DIR"
            install_bloodhound
            echo ""
        else
            echo -e "${BLUE}Starting existing BloodHound services...${NC}"
        start_bloodhound
        echo ""
    fi
    fi
    
    # Build and start cloud-tools container
    echo -e "${BLUE}Setting up cloud-tools container...${NC}"
    build_cloud_tools
    echo ""
    
    # Get password (after everything is set up)
    PASSWORD=$(get_bloodhound_password)
    
    # Display all usage instructions
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}Setup Complete!${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo -e "${BLUE}BloodHound Community Edition${NC}"
    echo ""
    echo -e "${YELLOW}Access BloodHound UI:${NC}"
    echo -e "  URL: ${GREEN}http://localhost:8080/ui/login${NC}"
    echo -e "  Username: ${GREEN}admin${NC}"
    echo -e "  Password: ${GREEN}${PASSWORD}${NC}"
    echo ""
    echo -e "${YELLOW}Useful BloodHound commands:${NC}"
    echo -e "  Start BloodHound:  ${GREEN}./${BH_DIR}/bloodhound-cli up${NC}"
    echo -e "  Stop BloodHound:   ${GREEN}./${BH_DIR}/bloodhound-cli down${NC}"
    echo -e "  Reset password:    ${GREEN}./${BH_DIR}/bloodhound-cli resetpwd${NC}"
    echo -e "  Update BloodHound:  ${GREEN}./${BH_DIR}/bloodhound-cli update${NC}"
    echo ""
    echo -e "${YELLOW}Note:${NC} You will be prompted to change the password on first login."
    echo ""
    echo -e "${BLUE}Azure Pentesting Tools Container${NC}"
    echo ""
    echo -e "${YELLOW}To access the Azure pentesting tools container:${NC}"
    echo -e "  ${GREEN}docker exec -it cloud-tools bash${NC}"
    echo ""
    echo -e "${YELLOW}Useful cloud-tools commands:${NC}"
    echo -e "  Rebuild container: ${GREEN}docker-compose build cloud-tools${NC}"
    echo -e "  Restart container:  ${GREEN}docker-compose restart cloud-tools${NC}"
    echo ""
}

# Show help screen
show_help() {
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}Azure Pentesting Tools Setup${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo -e "${YELLOW}Usage:${NC}"
    echo -e "  ${GREEN}./azpentest.sh${NC}              Show this help screen"
    echo -e "  ${GREEN}./azpentest.sh start${NC}        Install and start all services"
    echo -e "  ${GREEN}./azpentest.sh stop${NC}         Stop all services"
    echo -e "  ${GREEN}./azpentest.sh purge${NC}        Stop and delete all containers and resources"
    echo ""
    echo -e "${YELLOW}Commands:${NC}"
    echo -e "  ${GREEN}start${NC}  - Installs BloodHound CE (if not already installed),"
    echo -e "          starts BloodHound services, and builds/starts the cloud-tools container"
    echo ""
    echo -e "  ${GREEN}stop${NC}   - Stops BloodHound services and the cloud-tools container"
    echo ""
    echo -e "  ${GREEN}purge${NC}  - ${RED}WARNING:${NC} Stops and removes all containers, volumes,"
    echo -e "          images, and optionally the BloodHound installation directory."
    echo -e "          This action cannot be undone!"
    echo ""
    echo -e "${YELLOW}What this script does:${NC}"
    echo -e "  • Sets up BloodHound Community Edition in ${BH_DIR}/ directory"
    echo -e "  • Builds and starts the Azure pentesting tools container (cloud-tools)"
    echo -e "  • Provides access credentials and useful commands"
    echo ""
    echo -e "${YELLOW}Access:${NC}"
    echo -e "  BloodHound UI:     ${GREEN}http://localhost:8080/ui/login${NC}"
    echo -e "  Cloud Tools:       ${GREEN}docker exec -it cloud-tools bash${NC}"
    echo ""
}

# Stop all services
stop_all() {
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}Stopping All Services${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    
    # Stop cloud-tools container
    if docker ps --format '{{.Names}}' | grep -q "^cloud-tools$"; then
        echo -e "${BLUE}Stopping cloud-tools container...${NC}"
        cd "$SCRIPT_DIR"
        docker-compose stop cloud-tools >/dev/null 2>&1 || true
        echo -e "${GREEN}cloud-tools container stopped.${NC}"
    fi
    
    # Stop BloodHound using CLI
    if docker ps --format '{{.Names}}' | grep -q ".*-bloodhound-.*"; then
        echo -e "${BLUE}Stopping BloodHound services...${NC}"
        if [ -d "$BH_ABS_DIR" ]; then
            cd "$BH_ABS_DIR"
            if [ -f "./bloodhound-cli" ]; then
                ./bloodhound-cli down >/dev/null 2>&1 || true
            fi
        fi
        cd "$SCRIPT_DIR"
        echo -e "${GREEN}BloodHound services stopped.${NC}"
    fi
    
    echo ""
    echo -e "${GREEN}All services stopped.${NC}"
    echo ""
}

# Purge all containers and resources
purge_all() {
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}Purge All Containers and Resources${NC}"
    echo -e "${RED}========================================${NC}"
    echo ""
    
    # Check what will be removed
    HAS_ITEMS=false
    
    # Check for cloud-tools
    if docker ps -a --format '{{.Names}}' 2>/dev/null | grep -q "^cloud-tools$"; then
        HAS_ITEMS=true
    fi
    if docker images --format '{{.Repository}}' 2>/dev/null | grep -q "^azdocker-cloud-tools$"; then
        HAS_ITEMS=true
    fi
    
    # Check for BloodHound installation
    if [ -d "$BH_ABS_DIR" ]; then
        HAS_ITEMS=true
    fi
    
    # Check for data directory
    if [ -d "${SCRIPT_DIR}/data" ]; then
        HAS_ITEMS=true
    fi
    
    if [ "$HAS_ITEMS" = false ]; then
        echo -e "${GREEN}No resources found to remove.${NC}"
        echo ""
        return
    fi
    
    # Display what will be removed
    echo -e "${YELLOW}The following will be removed:${NC}"
    echo ""
    
    if docker ps -a --format '{{.Names}}' 2>/dev/null | grep -q "^cloud-tools$"; then
        echo -e "  ${RED}•${NC} cloud-tools container"
    fi
    if docker images --format '{{.Repository}}' 2>/dev/null | grep -q "^azdocker-cloud-tools$"; then
        echo -e "  ${RED}•${NC} azdocker-cloud-tools image"
    fi
    if [ -d "$BH_ABS_DIR" ]; then
        echo -e "  ${RED}•${NC} BloodHound installation (${BH_DIR}/) and all its resources"
    fi
    if [ -d "${SCRIPT_DIR}/data" ]; then
        echo -e "  ${RED}•${NC} data/ directory"
    fi
    echo ""
    
    echo -e "${RED}WARNING: This action cannot be undone!${NC}"
    echo ""
    read -p "Are you sure you want to continue? [y/N]: " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}Purge cancelled.${NC}"
        echo ""
        return
    fi
    echo ""
    
    # Stop and remove cloud-tools container and image
    echo -e "${BLUE}Removing cloud-tools container and image...${NC}"
    if docker ps --format '{{.Names}}' 2>/dev/null | grep -q "^cloud-tools$"; then
        docker stop cloud-tools >/dev/null 2>&1 || true
    fi
    if docker ps -a --format '{{.Names}}' 2>/dev/null | grep -q "^cloud-tools$"; then
        docker rm -f cloud-tools >/dev/null 2>&1 || true
    fi
    if docker images --format '{{.Repository}}' 2>/dev/null | grep -q "^azdocker-cloud-tools$"; then
        docker rmi azdocker-cloud-tools >/dev/null 2>&1 || true
    fi
    echo -e "${GREEN}cloud-tools removed.${NC}"
    echo ""
    
    # Use BloodHound CLI to uninstall (from the correct directory)
    if [ -d "$BH_ABS_DIR" ]; then
        echo -e "${BLUE}Removing BloodHound installation...${NC}"
        cd "$BH_ABS_DIR"
        if [ -f "./bloodhound-cli" ]; then
            # Pipe 'y' to confirm uninstall
            if command -v yes &> /dev/null; then
                yes 2>/dev/null | ./bloodhound-cli uninstall >/dev/null 2>&1 || true
            else
                printf 'y\ny\ny\n' 2>/dev/null | ./bloodhound-cli uninstall >/dev/null 2>&1 || true
            fi
        fi
        cd "$SCRIPT_DIR"
        echo -e "${GREEN}BloodHound Docker resources removed.${NC}"
        echo ""
    fi
    
    # Remove any remaining BloodHound volumes (in case uninstall didn't catch them)
    echo -e "${BLUE}Removing remaining BloodHound volumes...${NC}"
    BH_VOLUMES=$(docker volume ls --format '{{.Name}}' 2>/dev/null | grep -E ".*bh-.*|.*bloodhound.*|azdocker_bh-.*" || true)
    if [ -n "$BH_VOLUMES" ]; then
        echo "$BH_VOLUMES" | while IFS= read -r volume; do
            [ -z "$volume" ] && continue
            docker volume rm "$volume" >/dev/null 2>&1 || true
        done
        echo -e "${GREEN}BloodHound volumes removed.${NC}"
    else
        echo -e "${YELLOW}No BloodHound volumes found.${NC}"
    fi
    echo ""
    
    # Remove docker-compose network (azdocker_default)
    echo -e "${BLUE}Removing docker-compose network...${NC}"
    COMPOSE_NETWORK=$(docker network ls --format '{{.Name}}' 2>/dev/null | grep -E "^azdocker_default$" || true)
    if [ -n "$COMPOSE_NETWORK" ]; then
        echo "$COMPOSE_NETWORK" | while IFS= read -r network; do
            [ -z "$network" ] && continue
            docker network rm "$network" >/dev/null 2>&1 || true
        done
        echo -e "${GREEN}Network removed.${NC}"
    else
        echo -e "${YELLOW}No network found.${NC}"
    fi
    echo ""
    
    # Remove data directory
    if [ -d "${SCRIPT_DIR}/data" ]; then
        echo -e "${BLUE}Removing data/ directory...${NC}"
        rm -rf "${SCRIPT_DIR}/data"
        echo -e "${GREEN}data/ directory removed.${NC}"
        echo ""
    fi
    
    # Remove bloodhound directory as the last action
    if [ -d "$BH_ABS_DIR" ]; then
        echo -e "${BLUE}Removing ${BH_DIR}/ directory...${NC}"
        rm -rf "$BH_ABS_DIR"
        echo -e "${GREEN}${BH_DIR}/ directory removed.${NC}"
        echo ""
    fi
    
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}Purge Complete!${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo -e "${BLUE}All resources have been removed.${NC}"
    echo ""
    
    # Check tracked containers
}

# Parse command line arguments
case "${1:-}" in
    start)
        main
        ;;
    stop)
        stop_all
        ;;
    purge)
        purge_all
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        show_help
        ;;
    *)
        echo -e "${RED}Error: Unknown command '${1}'${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac

